<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SuperEngine-Home</title>
  <link href="https://lib.baomitu.com/uikit/3.2.3/css/uikit.min.css" rel="stylesheet">
  <script src="https://lib.baomitu.com/uikit/3.2.3/js/uikit.min.js"></script>
  <script src="https://lib.baomitu.com/uikit/3.2.3/js/uikit-icons.min.js"></script>
  <script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
</head>
<body>
<nav class="uk-navbar uk-navbar-container">
  <div class="uk-navbar-left">
    <ul class="uk-navbar-nav">
      <li><a href="index.html">SuperEngine</a></li>
      <li class="uk-active"><a href="#">Beta</a></li>
      <li><a href="#">Info</a></li>
      <li><a href="#">My Account</a></li>
    </ul>
  </div>
</nav>
<div class="uk-margin-right uk-margin-left uk-margin-top uk-text-center">
  <div id="my-loader" uk-spinner="ratio: 3"></div>
  <div>
    <a href="javascript:void(0)" onclick="openLikeList()">收藏夹</a>&nbsp;
    <a href="javascript:void(0)" onclick="openBanList()">黑名单</a>
  </div>
  <div id="vote" style="display: none">
    <span id="vote-node">评价最近使用的通道()</span>
    <a href="javascript:void(0)" onclick="likeNode()">收藏</a>&nbsp;
    <a href="javascript:void(0)" onclick="banNode()">拉黑</a>
  </div>
  <div id="list" class="uk-grid">

  </div>
  <div>
    <button class="uk-button uk-button-default" onclick="UIkit.modal($('#setting-modal')).show()">设置</button>
  </div>
</div>
<div id="connecting-modal" class="uk-modal">
  <div class="uk-modal-dialog uk-modal-body">
    <h2 id="connecting-modal-header" class="uk-modal-title">提示</h2>
    <div id="connecting-modal-body">

    </div>
    <p class="uk-text-right">
      <button class="uk-button uk-button-default uk-modal-close" type="button" onclick="onModalButtonClick()">确定</button>
    </p>
  </div>
</div>
<div id="setting-modal" class="uk-modal">
  <div class="uk-modal-dialog uk-modal-body">
    <h2 class="uk-modal-title">设置</h2>
    <div>
      <div class="uk-margin">
        <input id="connection_default" class="uk-input" type="text" placeholder="默认请求数(2)">
      </div>
      <div class="uk-margin">
        <input id="connection_mag" class="uk-input" type="text" placeholder="请求倍数(2)">
      </div>
      <div class="uk-margin">
        <input id="connection_max" class="uk-input" type="text" placeholder="最大请求数(8)">
      </div>
      <div class="uk-margin">
        <input id="connection_delay" class="uk-input" type="text" placeholder="请求间隔(10)ms">
      </div>
      <div class="uk-margin">
        <input id="connection_lag_limit" class="uk-input" type="text" placeholder="最大延迟(300)ms">
      </div>
    </div>
    <p>理论最大速度计算公式： 最大请求数*(1000/请求间隔)kb</p>
    <p>最大延迟：当检测到实际延迟超过设定的最大延迟后,减小请求数到默认请求数</p>
    <p class="uk-text-right">
      <button class="uk-button uk-button-default uk-modal-close" type="button" onclick="setting()">确定</button>
    </p>
  </div>
</div>
<script src="../js/custom.js"></script>
<script>
  var connect_info;
  var banList = [];
  var likeListM = [];
  var likeListR = [];
  window.onInjected = function(){
    var connectInfo = engine.localRead("connect_info.txt");
    var ban = engine.localRead("banList.txt");
    var likeM = engine.localRead("likeListM.txt");
    var likeR = engine.localRead("likeListR.txt");
    if(ban){
      try {
        banList = JSON.parse(ban);
      }catch(e){}
    }
    if(likeM){
      try{
        likeListM = JSON.parse(likeM);
      }catch (e) {}
    }
    if(likeR){
      try{
        likeListR = JSON.parse(likeR);
      }catch (e) {}
    }
    if(connectInfo){
      try {
        connect_info = JSON.parse(connectInfo);
        $("#vote-node").html("评价最近使用的通道("+connect_info.node+")");
        $("#vote").css("display", "block");
      }catch(e){}
    }
  };
  $.urlParam = function (name) {
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results == null) {
      return null;
    }
    return decodeURI(results[1]) || 0;
  };
  var token;

  (function () {
    var code = getCookie("code");
    token = getCookie("token");
    if (code == null || token == null) {
      window.location.href = "../index.html";
      return;
    }
    var json = JSON.parse(atob(code));
    var user = json['user'];
    var pass = json['pass'];
    $.get(encodeURI("http://localhost:1078/start?user=" + user + "&pass=" + pass), function (data) {
      if (data !== '') {
        alert(data)
      }
    });
    $.when($.ajax({
      url: encodeURI("http://120.53.27.21/wp-json/wp/v2/posts?categories=2"),
      type: 'GET',
      dataType: 'json',
      headers: {'Authorization': 'Bearer ' + token}
    }),$.ajax({
      url: encodeURI("http://120.53.27.21/wp-json/wp/v2/posts?categories=3"),
      type: 'GET',
      dataType: 'json',
      headers: {'Authorization': 'Bearer ' + token}
    })).done(function(res1,res2){
      var posts = res1[0];
      (function() {
        for (var i = 0; i < posts.length; i++) {
          var obj = posts[i];
          if ((new Date()) - (new Date(obj['modified'])) < 6 * 60 * 1000) {
            var title = obj['title']['rendered'];
            var res = obj['content']['rendered'].match(/[0-9\.]+/g);
            var host = res[0];
            var port = res[1];
            $("#list").append(createCard(title, host, port, "memcached"));
          }
        }
      })();
      posts = res2[0];
      (function() {
        for (var i = 0; i < posts.length; i++) {
          var obj = posts[i];
          if ((new Date()) - (new Date(obj['modified'])) < 6 * 60 * 1000) {
            var title = obj['title']['rendered'];
            var res = obj['content']['rendered'].match(/[0-9\.]+/g);
            var host = res[0];
            var port = res[1];
            $("#list").append(createCard(title, host, port, "redis"));
          }
        }
      })();
      $("#my-loader").css("display","none");
    });
  })();

  function createCard(name, host, port,type) {
    var img = "../img/alpha.png";
    return "  <div class=\"uk-width-1-3 uk-margin-bottom uk-margin-top\">" +
      "    <div class=\"uk-card uk-card-default uk-card-small\">" +
      "      <div class=\"uk-card-body uk-text-center\"><img src=\"" + img + "\"></div>" +
      "      <div class=\"uk-card-footer\">" +
      "         <p class=\"uk-text-center\">" + name +
      "         </p>" +
      "         <div>" +
      "          <button class=\"uk-button uk-button-primary uk-align-left\" onclick=\"findNode('" + name + "','" + host + "'," + port + ",'"+type+"')\">自动连接</button>" +
      "          <button class=\"uk-button uk-button-primary uk-align-right\" onclick=\"manualSelect('" + name + "','" + host + "'," + port + ",'"+type+"')\">手动连接</button>" +
      "        </div>" +
      "      </div>" +
      "    </div>" +
      "  </div>"
  }

  function manualSelect(name,host,port,type){
    switch (type) {
      case "memcached":
        if(likeListM.length===0){
          openModal("收藏夹","收藏夹为空");
          return;
        }
        var list = likeListM
          .map(function(v){ return '<li><a href="javascript:void(0)" onclick="connect(\''+name+'\',\''+host+'\',\''+port+'\',\''+type+'\',\''+v+'\')">'+v+'</a></li>' })
          .join("");
        var body = '<ul class="uk-list uk-list-divider">'+list+'</ul>';
        openModal("收藏夹",body);
        break;
      case "redis":
        if(likeListR.length===0){
          openModal("收藏夹","收藏夹为空");
          return;
        }
        var list = likeListR
          .map(function(v){ return '<li><a href="javascript:void(0)" onclick="connect(\''+name+'\',\''+host+'\',\''+port+'\',\''+type+'\',\''+v+'\')">'+v+'</a></li>' })
          .join("");
        var body = '<ul class="uk-list uk-list-divider">'+list+'</ul>';
        openModal("收藏夹",body);
        break;
    }
  }

  function findNode(name,host,port,type){
    switch (type) {
      case "memcached":
        $.ajax({
          url: encodeURI("http://120.53.27.21/client/memcached.json"),
          type: 'GET',
          dataType: 'json'
        }).always(function(res){
          nodeTest(name,host,port,type,likeListM.concat(res));
        });
        break;
      case "redis":
        $.ajax({
          url: encodeURI("http://120.53.27.21/client/redis.json"),
          type: 'GET',
          dataType: 'json'
        }).always(function(res){
          nodeTest(name,host,port,type,likeListR.concat(res));
        });
        break;
    }
  }

  function nodeTest(name,host,port,type,nodes){
    var filtered_nodes = nodes.filter(function(v){
      return banList.indexOf(v)<0
    });
    openModal("提示","正在寻找合适的中继通道,大约需要10s左右<div uk-spinner></div>");
    $.ajax({
      url:"http://localhost:1078/test/"+type,
      type: 'POST',
      dataType: 'json',
      contentType: 'application/json',
      data: JSON.stringify(filtered_nodes)
    }).always(function(res){
      if(res.status===1){
        connect(name,host,port,type,res.ip);
      }else{
        openModal("提示","无可用的中继通道("+JSON.stringify(res)+")");
      }
    })
  }

  function connect(name, host, port, type, next) {
    $.get("http://localhost:1078/connect?token=" + token + "&host=" + host + "&port=" + port + "&type="+type+"&name=" + name + "&client-next=" + next, function (data) {
      if (data != null && data !== '') {
        openModal("提示","连接失败," + data)
      } else {
        openModal("提示","连接成功");
        engine.localSave("connect_info.txt",JSON.stringify({"name":name,"host":host,"port":port,"type":type,"node":next}));
      }
    });
    openModal("提示","正在连接<div uk-spinner></div>");
  }

  function setting(){
    var connection_default = $('#connection_default').val();
    var connection_mag = $('#connection_mag').val();
    var connection_max = $('#connection_max').val();
    var connection_delay = $('#connection_delay').val();
    var connection_lag_limit = $('#connection_lag_limit').val();
    var data = {};
    if(connection_default && connection_default.length>0){
      data['connection_default'] = Number(connection_default);
    }
    if(connection_mag && connection_mag.length>0){
      data['connection_mag'] = Number(connection_mag);
    }
    if(connection_max && connection_max.length>0){
      data['connection_max'] = Number(connection_max);
    }
    if(connection_delay && connection_delay.length>0){
      data['connection_delay'] = Number(connection_delay);
    }
    if(connection_lag_limit && connection_lag_limit.length>0){
      data['connection_lag_limit'] = Number(connection_lag_limit);
    }
    $.ajax({
      url:'http://localhost:1078/settings',
      type: 'POST',
      dataType: 'json',
      contentType:'application/json',
      data:JSON.stringify(data)
    }).always(function(res){});
  }
  function banNode(){
    var node = connect_info.node;
    if(node){
      openModal("提示","拉黑该通道后，程序将不会再分配该通道。被多名用户拉黑的通道将从通道列表中删除。",function(){
        banList.push(node);
        engine.localSave("banlist.txt",JSON.stringify(banList));
        findNode(connect_info.name,connect_info.host,connect_info.port,connect_info.type);
      });
    }
  }

  function likeNode(){
    var node = connect_info.node;
    if(node){
      openModal("提示","收藏通道后，通道会在本地保存，不会因远程列表的更新而消失。",function(){
        if(connect_info.type==="memcached"){
          likeListM.push(node);
          engine.localSave("likeListM.txt",JSON.stringify(likeListM));
        }else if(connect_info.type==="redis"){
          likeListR.push(node);
          engine.localSave("likeListR.txt",JSON.stringify(likeListR));
        }
      });
    }
  }

  function deleteLikeNode(i,type){
    var nodes;
    var file;
    if(type==="memcached"){
      nodes = likeListM;
      file = "likeListM.txt";
    }else if(type==="redis"){
      nodes = likeListR;
      file = "likeListR.txt";
    }
    nodes.splice(i,1);
    engine.localSave(file,JSON.stringify(nodes));
  }

  function deleteBanNode(i){
    banList.splice(i,1);
    engine.localSave("banList.txt",JSON.stringify(banList));
    openBanList();
  }

  function openLikeList(){
    var listM = likeListM
      .map(function(v,index){ return '<li><span>'+v+'</span><a href="javascript:void(0)" onclick="deleteLikeNode('+index+',\'memcached\')">删除</a></li>' })
      .join("");
    var listR = likeListR
      .map(function(v,index){ return '<li><span>'+v+'</span><a href="javascript:void(0)" onclick="deleteLikeNode('+index+',\'redis\')">删除</a></li>' })
      .join("");
    var body = '<ul class="uk-list-divider"><li>M-</li>'+listM+'<li>R-</li>'+listR+'</ul>';
    openModal('收藏夹',body)
  }

  function openBanList(){
    var list = banList
      .map(function(v,index){ return '<li><span>'+v+'</span><a href="javascript:void(0)" onclick="deleteBanNode('+index+')">删除</a></li>' })
      .join("");
    var body = '<ul class="uk-list-divider">'+list+'</ul>';
    openModal('黑名单',body);
  }

  function openModal(header,body,callback){
    UIkit.modal($("#connecting-modal")).hide();
    $('#connecting-modal-header').html(header);
    $('#connecting-modal-body').html(body);
    if(callback)
      window.onModalButtonClick = callback;
    else
      window.onModalButtonClick = function(){};
    UIkit.modal($("#connecting-modal")).show();
  }
</script>
</body>
</html>
