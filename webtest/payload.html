<script>
  function replaceUrl(element, attr) {
    let src = element.getAttribute(attr);
    if (src && src.length > 0 && !src.startsWith(parent.base)) {
      if (src.startsWith("data:")) {
        return;
      }
      element.setAttribute(attr, parent.parseURL('GET', src));
    }
  }

  window.XMLHttpRequest0 = XMLHttpRequest;
  const XMLHttpRequest0Handler = {
    get: function (obj, prop) {
      console.log(prop);
      if (prop === 'send') {
        return obj[prop];
      } else
        return obj[prop];
    }
  };
  delete window.XMLHttpRequest;
  window.XMLHttpRequest = function () {
    return new Proxy(new XMLHttpRequest0(), XMLHttpRequest0Handler);
  }
  let observer = new MutationObserver(function (m) {
    m.forEach(record => {
      let replaceList = [];
      replaceList.push(record.target);
      replaceList.concat(record.addedNodes);
      replaceList.forEach(node => {
        switch (node.nodeName.toLowerCase()) {
          case "img":
          case "video":
          case "script":
            replaceUrl(node, "src");
            break;
          case "link":
          case "a":
            replaceUrl(node, "href");
            break;
          case "form":
            replaceUrl(node, "action");
            break;
        }
      })
    })
  });
  window.addEventListener('DOMContentLoaded', (event) => {
    observer.observe(document.querySelector('body'), {
      attributes: true,
      characterData: true,
      childList: true,
      subtree: true,
      attributeOldValue: true,
      characterDataOldValue: true
    });
    document.querySelectorAll("img").forEach(v => replaceUrl(v, "src"));
    document.querySelectorAll("video").forEach(v => replaceUrl(v, "src"));
    document.querySelectorAll("script").forEach(v => replaceUrl(v, "src"));
    document.querySelectorAll("link").forEach(v => replaceUrl(v, "href"));
    document.querySelectorAll("a").forEach(v => replaceUrl(v, "href"));
    document.querySelectorAll("form").forEach(v => replaceUrl(v, "action"))
  });
  window.addEventListener('unload', function (event) {
    parent.postMessage("navigation", "*");
  });
</script>
